{% extends "base.html" %}

{% block title %}Отчёты - Личный бюджет{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <h2 class="mb-4"><i class="bi bi-graph-up me-2"></i>Отчёты</h2>

  <!-- Графики -->
  <div class="row g-4 mb-4">
    <!-- Доходы vs Расходы -->
    <div class="col-md-6">
      <div class="card shadow-lg">
        <div class="card-header bg-gradient-primary">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Доходы vs Расходы</h5>
            <div class="d-flex align-items-center gap-2">
              <a href="{{ url_for('report', month=prev_month, year=prev_year) }}" 
                 class="btn btn-sm btn-outline-light" title="Предыдущий месяц">
                <i class="bi bi-chevron-left"></i>
              </a>
              <span class="fw-bold text-white">{{ month_names[month] }} {{ year }}</span>
              <a href="{{ url_for('report', month=next_month, year=next_year) }}" 
                 class="btn btn-sm btn-outline-light" title="Следующий месяц">
                <i class="bi bi-chevron-right"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="card-body position-relative">
          <div class="chart-container" style="position: relative; height: 300px;">
            <canvas id="incomeExpenseChart"></canvas>
            <!-- Затемнённая половина за прошлый месяц -->
            <div class="chart-overlay-prev" style="position: absolute; left: 0; top: 0; width: 50%; height: 100%; 
                 background: linear-gradient(90deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.1) 100%); 
                 pointer-events: none; border-radius: 0 0 0 8px; z-index: 1;"></div>
          </div>
          <!-- Сравнение с прошлым месяцем -->
          <div class="mt-3 p-3 bg-dark rounded" style="background: var(--bg-tertiary) !important;">
            <div class="row text-center">
              <div class="col-6 border-end border-secondary">
                <small class="text-muted d-block">Текущий месяц</small>
                <div class="mt-1">
                  <span class="badge bg-success me-1">+{{ "%.2f"|format(current_income) }}</span>
                  <span class="badge bg-danger">-{{ "%.2f"|format(current_expense) }}</span>
                </div>
              </div>
              <div class="col-6">
                <small class="text-muted d-block">Прошлый месяц</small>
                <div class="mt-1">
                  <span class="badge bg-success bg-opacity-50 me-1">+{{ "%.2f"|format(prev_income) }}</span>
                  <span class="badge bg-danger bg-opacity-50">-{{ "%.2f"|format(prev_expense) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Расходы по категориям -->
    <div class="col-md-6">
      <div class="card shadow-lg">
        <div class="card-header bg-gradient-primary">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Расходы по категориям</h5>
            <div class="d-flex align-items-center gap-2">
              <a href="{{ url_for('report', month=prev_month, year=prev_year) }}" 
                 class="btn btn-sm btn-outline-light" title="Предыдущий месяц">
                <i class="bi bi-chevron-left"></i>
              </a>
              <span class="fw-bold text-white">{{ month_names[month] }} {{ year }}</span>
              <a href="{{ url_for('report', month=next_month, year=next_year) }}" 
                 class="btn btn-sm btn-outline-light" title="Следующий месяц">
                <i class="bi bi-chevron-right"></i>
              </a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="position: relative; height: 350px;">
            <canvas id="categoriesChart"></canvas>
          </div>
          <!-- Список категорий с суммами -->
          <div id="categoriesList" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Таблица по категориям -->
  <div class="card mb-4 shadow-lg">
    <div class="card-header bg-gradient-primary">
      <h5 class="mb-0">Суммы по категориям</h5>
    </div>
    <div class="card-body">
      {% if not by_cat.empty %}
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>Категория</th>
                <th>Сумма ({{currency}})</th>
              </tr>
            </thead>
            <tbody>
              {% for idx, row in by_cat.iterrows() %}
                <tr class="animate-slide-in">
                  <td>
                    <span class="badge" style="background-color: #6366f1;">
                      {{idx}}
                    </span>
                  </td>
                  <td><strong>{{"%.2f"|format(row['amount'])}}</strong></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted text-center">Нет данных за выбранный период</p>
      {% endif %}
    </div>
  </div>

  <!-- Цели -->
  {% if goals_progress %}
    <div class="card shadow-lg">
      <div class="card-header bg-gradient-primary">
        <h5 class="mb-0">Прогресс целей</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          {% for item in goals_progress %}
            <div class="col-md-6">
              <div class="card border-secondary shadow-sm">
                <div class="card-body">
                  <h6 class="mb-2">{{ item.goal.name }}</h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Прогресс</span>
                    <strong>{{ "%.0f"|format(item.percent) }}%</strong>
                  </div>
                  <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" style="width: {{item.percent}}%;">
                      {{ "%.0f"|format(item.percent) }}%
                    </div>
                  </div>
                  <small class="text-muted">
                    {{ "%.2f"|format(item.progress) }} / {{ "%.2f"|format(item.goal.target_amount) }} {{currency}}
                  </small>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
  .bg-gradient-primary {
    background: linear-gradient(135deg, var(--accent-primary) 0%, #3d5afe 100%) !important;
    border: none;
  }

  .chart-container {
    position: relative;
  }

  .chart-overlay-prev {
    position: absolute;
    left: 0;
    top: 0;
    width: 50%;
    height: 100%;
    background: linear-gradient(90deg, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.05) 100%);
    pointer-events: none;
    border-radius: 0 0 0 8px;
    z-index: 1;
  }

  .card-header {
    border-bottom: 1px solid var(--border-color);
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // График доходы/расходы с прошлым месяцем
  fetch(`/api/chart/income-expense?month={{month}}&year={{year}}`)
    .then(response => response.json())
    .then(data => {
      const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
      
      // Данные за прошлый месяц
      const prevData = {
        income: {{ prev_income }},
        expense: {{ prev_expense }}
      };
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Доходы (текущий)', 'Расходы (текущий)', 'Доходы (прошлый)', 'Расходы (прошлый)'],
          datasets: [
            {
              label: 'Текущий месяц',
              data: [data.income, data.expense, 0, 0],
              backgroundColor: ['#3fb950', '#f85149', 'transparent', 'transparent'],
              borderWidth: 3,
              borderColor: '#0d1117',
              cutout: '60%'
            },
            {
              label: 'Прошлый месяц (затемнённый)',
              data: [0, 0, prevData.income, prevData.expense],
              backgroundColor: ['transparent', 'transparent', 'rgba(63, 185, 80, 0.3)', 'rgba(248, 81, 73, 0.3)'],
              borderWidth: 2,
              borderColor: 'rgba(255, 255, 255, 0.2)',
              cutout: '60%'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { 
                color: '#e6edf3',
                padding: 15,
                filter: function(item, chart) {
                  // Показываем только текущий месяц в легенде
                  return item.datasetIndex === 0;
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 0 && context.dataIndex < 2) {
                    return context.label + ': ' + context.parsed.toFixed(2) + ' {{currency}}';
                  }
                  return '';
                }
              }
            }
          }
        }
      });
    });

  // График по категориям - Donut Chart
  fetch(`/api/chart/categories?month={{month}}&year={{year}}`)
    .then(response => response.json())
    .then(result => {
      const data = result.data || result; // Поддержка старого формата
      const info = result.info || {};
      
      const ctx = document.getElementById('categoriesChart').getContext('2d');
      
      // Сортируем категории по сумме (от большего к меньшему)
      const sortedEntries = Object.entries(data).sort((a, b) => b[1] - a[1]);
      const labels = sortedEntries.map(([name]) => name);
      const values = sortedEntries.map(([, amount]) => amount);
      const total = values.reduce((sum, val) => sum + val, 0);
      
      // Получаем цвета и иконки для каждой категории
      const colors = labels.map(name => {
        return info[name]?.color || '#6366f1';
      });
      
      // Плагин для отображения текста в центре donut chart
      const centerTextPlugin = {
        id: 'centerText',
        afterDraw(chart) {
          const {ctx, chartArea: {left, right, top, bottom}} = chart;
          ctx.save();
          const centerX = (left + right) / 2;
          const centerY = (top + bottom) / 2;
          
          ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.fillStyle = '#e6edf3';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(total.toFixed(0) + ' ₽', centerX, centerY - 12);
          
          ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
          ctx.fillStyle = '#b1bac4';
          ctx.fillText('Траты', centerX, centerY + 18);
          ctx.restore();
        }
      };
      
      // Создаём donut chart
      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderColor: '#0d1117',
            borderWidth: 3,
            hoverOffset: 8
          }]
        },
        plugins: [centerTextPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return label + ': ' + value.toFixed(2) + ' {{currency}} (' + percent + '%)';
                }
              },
              backgroundColor: 'rgba(13, 17, 23, 0.95)',
              titleColor: '#e6edf3',
              bodyColor: '#e6edf3',
              borderColor: '#30363d',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              boxPadding: 6
            }
          },
          onHover: (event, activeElements) => {
            event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
          }
        }
      });
      
      // Создаём список категорий с суммами и процентами
      const categoriesList = document.getElementById('categoriesList');
      if (categoriesList) {
        let html = '<div class="list-group list-group-flush">';
        sortedEntries.forEach(([name, amount], index) => {
          const percent = total > 0 ? ((amount / total) * 100).toFixed(0) : 0;
          const categoryInfo = info[name] || {};
          const icon = categoryInfo.icon || 'bi-circle';
          const color = categoryInfo.color || '#6366f1';
          
          html += `
            <div class="list-group-item bg-transparent border-secondary d-flex justify-content-between align-items-center py-2">
              <div class="d-flex align-items-center">
                <i class="${icon} me-2" style="color: ${color}; font-size: 1.2rem;"></i>
                <span class="text-white">${name}</span>
              </div>
              <div class="d-flex align-items-center gap-3">
                <span class="text-muted">${percent}%</span>
                <strong class="text-white">${amount.toFixed(0)} ₽</strong>
              </div>
            </div>
          `;
        });
        html += '</div>';
        categoriesList.innerHTML = html;
      }
    });
</script>
{% endblock %}
