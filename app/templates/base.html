<!doctype html>
<html lang="ru" data-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Личный бюджет{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary mb-4 shadow-lg">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('index') }}">
          <i class="bi bi-wallet2 me-2 fs-4"></i>
          <span>Личный бюджет</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('index') }}">
                <i class="bi bi-house-door me-1"></i>Главная
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('transactions') }}">
                <i class="bi bi-list-ul me-1"></i>Операции
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('add_transaction') }}">
                <i class="bi bi-plus-circle me-1"></i>Добавить
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-gear me-1"></i>Настройки
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="{{ url_for('categories') }}">
                  <i class="bi bi-tags me-2"></i>Категории
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('tags') }}">
                  <i class="bi bi-bookmark me-2"></i>Теги
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('accounts') }}">
                  <i class="bi bi-credit-card me-2"></i>Счета
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('budgets') }}">
                  <i class="bi bi-piggy-bank me-2"></i>Бюджеты
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('templates') }}">
                  <i class="bi bi-file-earmark-text me-2"></i>Шаблоны
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('planned_expenses') }}">
                  <i class="bi bi-calendar-check me-2"></i>Планирование
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('recurring_list') }}">
                  <i class="bi bi-arrow-repeat me-2"></i>Повторяющиеся
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('goals') }}">
                  <i class="bi bi-bullseye me-2"></i>Цели
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('debts') }}">
                  <i class="bi bi-cash-coin me-2"></i>Долги
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('transfer') }}">
                  <i class="bi bi-arrow-left-right me-2"></i>Перевод между счетами
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('achievements') }}">
                  <i class="bi bi-trophy me-2"></i>Достижения
                </a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link position-relative" href="{{ url_for('notifications') }}">
                <i class="bi bi-bell me-1"></i>Уведомления
                {% if unread_count > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    {{ unread_count }}
                  </span>
                {% endif %}
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('report') }}">
                <i class="bi bi-graph-up me-1"></i>Отчёты
              </a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-download-upload me-1"></i>Импорт/Экспорт
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="{{ url_for('import_csv') }}">
                  <i class="bi bi-upload me-2"></i>Импорт CSV
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('export_csv') }}">
                  <i class="bi bi-download me-2"></i>Экспорт CSV
                </a></li>
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav ms-auto">
            {% if current_user %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"></i>{{ current_user.username }}
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="{{ url_for('account') }}">
                  <i class="bi bi-person me-2"></i>Мой аккаунт
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                  <i class="bi bi-box-arrow-right me-2"></i>Выйти
                </a></li>
              </ul>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('login') }}">Войти</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('register') }}">Зарегистрироваться</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm animate-fade-in" role="alert">
                <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      // Горячие клавиши
      document.addEventListener('keydown', function(e) {
        // Ctrl+N или Cmd+N - новая операция
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          window.location.href = '{{ url_for("add_transaction") }}';
        }
        // Ctrl+F или Cmd+F - поиск (если на странице операций)
        if ((e.ctrlKey || e.metaKey) && e.key === 'f' && window.location.pathname.includes('/transactions')) {
          e.preventDefault();
          document.querySelector('input[name="query"]')?.focus();
        }
        // Ctrl+/ или Cmd+/ - показать справку по горячим клавишам
        if ((e.ctrlKey || e.metaKey) && e.key === '/') {
          e.preventDefault();
          showKeyboardShortcuts();
        }
        // Esc - закрыть модальные окна
        if (e.key === 'Escape') {
          const modals = document.querySelectorAll('.modal.show');
          modals.forEach(modal => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
          });
        }
      });

      function showKeyboardShortcuts() {
        const shortcuts = [
          { key: 'Ctrl+N / Cmd+N', desc: 'Добавить новую операцию' },
          { key: 'Ctrl+F / Cmd+F', desc: 'Поиск (на странице операций)' },
          { key: 'Esc', desc: 'Закрыть модальное окно' },
          { key: 'Ctrl+/ / Cmd+/', desc: 'Показать эту справку' }
        ];
        
        let html = '<div class="list-group">';
        shortcuts.forEach(s => {
          html += `<div class="list-group-item bg-dark text-white border-secondary">
            <div class="d-flex justify-content-between">
              <span>${s.desc}</span>
              <kbd class="bg-secondary">${s.key}</kbd>
            </div>
          </div>`;
        });
        html += '</div>';
        
        // Показываем в alert или создаём модальное окно
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
              <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-keyboard me-2"></i>Горячие клавиши</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                ${html}
              </div>
              <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', () => modal.remove());
      }
    </script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
