{% extends "base.html" %}

{% block title %}Операции - Личный бюджет{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-list-ul me-2"></i>Операции</h2>
    <a href="{{ url_for('add_transaction') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-2"></i>Добавить операцию
    </a>
  </div>

  <!-- Быстрые фильтры -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2">
        <a href="{{ url_for('transactions', quick_filter='today') }}" 
           class="btn btn-sm {% if quick_filter == 'today' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-calendar-day me-1"></i>Сегодня
        </a>
        <a href="{{ url_for('transactions', quick_filter='week') }}" 
           class="btn btn-sm {% if quick_filter == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-calendar-week me-1"></i>Неделя
        </a>
        <a href="{{ url_for('transactions', quick_filter='month') }}" 
           class="btn btn-sm {% if quick_filter == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-calendar-month me-1"></i>Месяц
        </a>
        <a href="{{ url_for('transactions', quick_filter='year') }}" 
           class="btn btn-sm {% if quick_filter == 'year' %}btn-primary{% else %}btn-outline-primary{% endif %}">
          <i class="bi bi-calendar me-1"></i>Год
        </a>
        <div class="vr"></div>
        <a href="{{ url_for('transactions', quick_filter='income_only') }}" 
           class="btn btn-sm {% if quick_filter == 'income_only' %}btn-success{% else %}btn-outline-success{% endif %}">
          <i class="bi bi-arrow-down-circle me-1"></i>Только доходы
        </a>
        <a href="{{ url_for('transactions', quick_filter='expense_only') }}" 
           class="btn btn-sm {% if quick_filter == 'expense_only' %}btn-danger{% else %}btn-outline-danger{% endif %}">
          <i class="bi bi-arrow-up-circle me-1"></i>Только расходы
        </a>
        <a href="{{ url_for('transactions') }}" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-x-circle me-1"></i>Сбросить
        </a>
      </div>
    </div>
  </div>

  <!-- Поиск и фильтры -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="{{ url_for('transactions') }}" class="row g-3">
        <input type="hidden" name="quick_filter" value="{{ quick_filter }}">
        <div class="col-md-3">
          <label class="form-label">Поиск</label>
          {{ form.query(class="form-control", placeholder="Поиск по примечанию...") }}
        </div>
        <div class="col-md-2">
          <label class="form-label">Тип</label>
          {{ form.type(class="form-select") }}
        </div>
        <div class="col-md-2">
          <label class="form-label">Категория</label>
          {{ form.category(class="form-select") }}
        </div>
        <div class="col-md-2">
          <label class="form-label">Счёт</label>
          {{ form.account(class="form-select") }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Диапазон сумм</label>
          <div class="input-group">
            {{ form.amount_from(class="form-control", placeholder="От") }}
            <span class="input-group-text">-</span>
            {{ form.amount_to(class="form-control", placeholder="До") }}
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">С</label>
          {{ form.date_from(class="form-control") }}
        </div>
        <div class="col-md-2">
          <label class="form-label">По</label>
          {{ form.date_to(class="form-control") }}
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-search me-1"></i>Поиск
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Таблица операций -->
  <div class="card">
    <div class="card-body">
      {% if transactions %}
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <strong>Найдено операций: {{ transactions|length }}</strong>
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
              <i class="bi bi-check-square me-1"></i>Выбрать все
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="deselectAll()">
              <i class="bi bi-square me-1"></i>Снять выбор
            </button>
            <button type="button" class="btn btn-outline-warning" onclick="showBulkEdit()" id="bulkEditBtn" disabled>
              <i class="bi bi-pencil me-1"></i>Массовое редактирование (<span id="selectedCount">0</span>)
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
              <i class="bi bi-trash me-1"></i>Удалить выбранные
            </button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th width="40">
                  <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleAll(this)">
                </th>
                <th>Дата</th>
                <th>Тип</th>
                <th>Сумма</th>
                <th>Категория</th>
                <th>Счёт</th>
                <th>Примечание</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transactions %}
                <tr class="animate-slide-in">
                  <td>
                    <input type="checkbox" class="form-check-input transaction-checkbox" 
                           value="{{ t.id }}" onchange="updateSelection()">
                  </td>
                  <td>{{ t.date.strftime("%d.%m.%Y") }}</td>
                  <td>
                    <span class="badge {% if t.type.value == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                      {% if t.type.value == 'income' %}
                        <i class="bi bi-arrow-down-circle"></i> Доход
                      {% else %}
                        <i class="bi bi-arrow-up-circle"></i> Расход
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <strong class="{% if t.type.value == 'income' %}text-success{% else %}text-danger{% endif %}">
                      {% if t.type.value == 'income' %}+{% else %}-{% endif %}{{ "%.2f"|format(t.amount) }} {{ currency }}
                    </strong>
                  </td>
                  <td>
                    {% if t.category %}
                      <span class="badge" style="background-color: {{ t.category.color or '#6366f1' }}">
                        {{ t.category.name }}
                      </span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if t.account %}
                      <span class="badge bg-secondary">{{ t.account.name }}</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>{{ t.note or "—" }}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a href="{{ url_for('edit_transaction', trans_id=t.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <form method="POST" action="{{ url_for('delete_transaction', trans_id=t.id) }}" class="d-inline" 
                            onsubmit="return confirm('Удалить операцию?');">
                        <button type="submit" class="btn btn-outline-danger">
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-inbox fs-1 text-muted"></i>
          <p class="text-muted mt-3">Нет операций</p>
          <a href="{{ url_for('add_transaction') }}" class="btn btn-primary">Добавить операцию</a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Модальное окно для массового редактирования -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Массовое редактирование</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="bulkEditForm">
          <div class="mb-3">
            <label class="form-label">Изменить категорию</label>
            <select class="form-select" id="bulkCategory">
              <option value="">Не изменять</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Изменить счёт</label>
            <select class="form-select" id="bulkAccount">
              <option value="">Не изменять</option>
              {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" onclick="applyBulkEdit()">
          <i class="bi bi-check me-1"></i>Применить
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleAll(checkbox) {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateSelection();
  }

  function selectAll() {
    document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = true);
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = true;
    }
    updateSelection();
  }

  function deselectAll() {
    document.querySelectorAll('.transaction-checkbox').forEach(cb => cb.checked = false);
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
    }
    updateSelection();
  }

  function updateSelection() {
    const selected = document.querySelectorAll('.transaction-checkbox:checked');
    const count = selected.length;
    const countElement = document.getElementById('selectedCount');
    const bulkEditBtn = document.getElementById('bulkEditBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    
    if (countElement) {
      countElement.textContent = count;
    }
    if (bulkEditBtn) {
      bulkEditBtn.disabled = count === 0;
    }
    if (bulkDeleteBtn) {
      bulkDeleteBtn.disabled = count === 0;
    }
  }

  function showBulkEdit() {
    const selected = document.querySelectorAll('.transaction-checkbox:checked');
    if (selected.length === 0) {
      alert('Выберите хотя бы одну операцию');
      return;
    }
    const modal = new bootstrap.Modal(document.getElementById('bulkEditModal'));
    modal.show();
  }

  function applyBulkEdit() {
    const selected = Array.from(document.querySelectorAll('.transaction-checkbox:checked')).map(cb => cb.value);
    const category = document.getElementById('bulkCategory').value;
    const account = document.getElementById('bulkAccount').value;

    if (!category && !account) {
      alert('Выберите хотя бы одно поле для изменения');
      return;
    }

    fetch('/api/transactions/bulk-edit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        transaction_ids: selected,
        category_id: category || null,
        account_id: account || null
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Ошибка при редактировании');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ошибка при редактировании');
    });
  }

  function bulkDelete() {
    const selected = Array.from(document.querySelectorAll('.transaction-checkbox:checked')).map(cb => cb.value);
    if (selected.length === 0) {
      alert('Выберите хотя бы одну операцию');
      return;
    }

    if (!confirm(`Удалить ${selected.length} операций?`)) return;

    fetch('/api/transactions/bulk-delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        transaction_ids: selected
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Ошибка при удалении');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ошибка при удалении');
    });
  }

  // Инициализация при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
    updateSelection();
  });
</script>
{% endblock %}
